# Niro Agent Dashboard Deployment Guide

Complete guide for deploying the Niro Agent Dashboard to AWS with custom domain `dev-visualforge.ai/agents/dashboard`.

## ğŸš€ Quick Start

### 1. Local Testing with Docker

First, test everything locally to ensure it works before deploying to AWS:

```bash
# Make scripts executable
chmod +x test-docker-setup.sh
chmod +x setup-aws-oidc.sh

# Test locally with Docker (simulates production environment)
./test-docker-setup.sh
```

This will:
- Build and start all services (API on port 7777, Frontend on port 3000)
- Set up Nginx proxy to simulate `dev-visualforge.ai/agents/dashboard` routing
- Validate all services are healthy
- Provide test URLs for validation

**Test URLs:**
- Frontend: http://localhost:3000
- API: http://localhost:7778
- **Production Simulation**: http://localhost/agents/dashboard
- API through proxy: http://localhost/api

### 2. AWS OIDC Setup (One-time)

Configure GitHub Actions to deploy to AWS:

```bash
# Ensure AWS CLI is configured
aws configure

# Run OIDC setup script
./setup-aws-oidc.sh
```

Follow the prompts and add the generated `AWS_ROLE_ARN` secret to your GitHub repository.

### 3. Deploy to AWS

Once local testing passes and OIDC is configured:

```bash
git add .
git commit -m "feat: dashboard deployment ready"
git push origin main  # or your branch name
```

GitHub Actions will automatically:
1. Deploy infrastructure (S3, CloudFront, Lambda)
2. Build and deploy frontend to S3
3. Deploy API to EC2 agent server
4. Configure security groups and routing

## ğŸ“‹ Deployment Architecture

```
dev-visualforge.ai/agents/dashboard
           â†“
    CloudFront Distribution
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  /agents/dashboard    â”‚      /api/*        â”‚
    â”‚      (S3 Origin)      â”‚   (EC2 Origin)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                       â†“
    S3 Static Website        EC2 Agent Server
    (React Frontend)         (Node.js API:7777)
```

## ğŸ”§ Configuration Details

### Environment Variables Required

**For Local Development:**
- `AWS_ACCESS_KEY_ID` - Your AWS access key
- `AWS_SECRET_ACCESS_KEY` - Your AWS secret key
- `GITHUB_TOKEN` - GitHub personal access token
- `ANTHROPIC_API_KEY` - Claude API key
- `AGENT_EC2_INSTANCE_ID` - Agent server instance ID (default: i-0af59b7036f7b0b77)

**For Production (GitHub Secrets):**
- `AWS_ROLE_ARN` - Generated by setup-aws-oidc.sh script

### CloudFormation Stacks

The deployment creates the following stacks:
- `niro-agent-dashboard-dev-infrastructure` - Core infrastructure
- `niro-agent-dashboard-staging-infrastructure` - Staging environment  
- `niro-agent-dashboard-prod-infrastructure` - Production environment

### Custom Domain Configuration

To configure the custom domain `dev-visualforge.ai/agents/dashboard`:

1. **SSL Certificate**: Ensure you have a valid SSL certificate for `dev-visualforge.ai` in AWS Certificate Manager (us-east-1 region)

2. **Deploy with Domain**:
```bash
# Deploy infrastructure with custom domain
aws cloudformation deploy \
  --template-file infrastructure/dashboard-infrastructure.yaml \
  --stack-name niro-agent-dashboard-dev-infrastructure \
  --parameter-overrides \
    Environment=dev \
    DomainName=dev-visualforge.ai \
    CertificateArn=arn:aws:acm:us-east-1:ACCOUNT:certificate/YOUR-CERT-ID \
  --capabilities CAPABILITY_IAM
```

3. **DNS Configuration**: Update your DNS to point `dev-visualforge.ai` to the CloudFront distribution domain

## ğŸ›  Troubleshooting

### Common Issues

**Docker Issues:**
```bash
# Clean up containers
docker-compose -f docker-compose.local.yml down --remove-orphans

# Rebuild from scratch
docker-compose -f docker-compose.local.yml up --build --force-recreate
```

**API Server Issues:**
```bash
# Check agent server status
aws ssm send-command \
  --instance-ids i-0af59b7036f7b0b77 \
  --document-name "AWS-RunShellScript" \
  --parameters 'commands=["systemctl status niro-agent-api"]'
```

**GitHub Actions Issues:**
- Verify `AWS_ROLE_ARN` secret is correctly set
- Check CloudFormation stack events for detailed error messages
- Ensure OIDC provider exists and role has correct permissions

### Logs and Monitoring

**Local Logs:**
```bash
# View all container logs
docker-compose -f docker-compose.local.yml logs -f

# View specific service logs
docker-compose -f docker-compose.local.yml logs -f api
docker-compose -f docker-compose.local.yml logs -f mfe
```

**Production Logs:**
- CloudWatch Logs for Lambda functions
- CloudFront access logs
- EC2 instance logs via SSM or CloudWatch agent

## ğŸ¯ Testing Checklist

Before deploying to production, verify:

- [ ] Local Docker setup passes all health checks
- [ ] Frontend loads correctly at simulated domain
- [ ] API responds correctly through proxy
- [ ] Agent data is loading (50 real agents detected)
- [ ] WebSocket connections work for live updates
- [ ] CORS is properly configured
- [ ] SSL/TLS certificates are valid
- [ ] GitHub Actions secrets are configured

## ğŸ“š File Structure

```
na-agent-dashboard/
â”œâ”€â”€ api/                          # Node.js API server
â”œâ”€â”€ mfe/                          # React frontend
â”œâ”€â”€ infrastructure/               # CloudFormation templates
â”‚   â””â”€â”€ dashboard-infrastructure.yaml
â”œâ”€â”€ .github/workflows/           # GitHub Actions
â”‚   â”œâ”€â”€ deploy-infrastructure.yml
â”‚   â””â”€â”€ deploy-application.yml
â”œâ”€â”€ docker/                      # Nginx configuration for local testing
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â””â”€â”€ default.conf
â”œâ”€â”€ docker-compose.local.yml     # Local development environment
â”œâ”€â”€ test-docker-setup.sh         # Local testing script
â”œâ”€â”€ setup-aws-oidc.sh           # One-time AWS setup
â””â”€â”€ DEPLOYMENT_GUIDE.md         # This file
```

## ğŸ”„ Deployment Workflow

1. **Development**: Code and test locally with Docker
2. **Testing**: Run `./test-docker-setup.sh` to validate
3. **Commit**: Push changes to trigger GitHub Actions
4. **Deploy**: GitHub Actions handles infrastructure and application deployment
5. **Verify**: Check `dev-visualforge.ai/agents/dashboard` is accessible

## ğŸ¤ Coordination

This AI is responsible for:
- âœ… Dashboard deployment to S3
- âœ… Agent EC2 server API deployment  
- âœ… CloudFront and domain configuration
- âœ… GitHub Actions CI/CD pipeline

The other AI is handling:
- ğŸ”„ Agent system conversion from Python to TypeScript
- ğŸ”„ Agent orchestration and task management
- ğŸ”„ Cost optimization and monitoring

## ğŸ‰ Success Criteria

Deployment is successful when:
- Dashboard is accessible at `https://dev-visualforge.ai/agents/dashboard`
- API endpoints respond correctly via `/api/*` routing
- Real agent data loads (50+ agents visible)
- Live updates work via WebSocket connections
- Cost monitoring shows continued $600+/month savings
- All automated tests pass in GitHub Actions
